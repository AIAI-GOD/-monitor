name: Auto Update Gold Price Data

on:
  schedule:
    # UTC时间09:00 = 北京时间17:00（UTC+8），每天运行
    - cron: '0 9 * * *'
  workflow_dispatch:  # 允许手动触发运行

jobs:
  update-gold-data:
    name: Update Gold Price CSV
    runs-on: ubuntu-latest
    permissions:
      contents: write  # 显式声明推送代码的权限（关键）
    
    steps:
      - name: 检出仓库代码
        uses: actions/checkout@v4  # 升级到最新稳定版
        with:
          ref: main  # 指定默认分支（适配现代GitHub仓库）

      - name: 设置Python环境
        uses: actions/setup-python@v5  # 升级到最新稳定版
        with:
          python-version: '3.9'
          cache: 'pip'  # 缓存pip依赖，避免重复安装

      - name: 安装Python依赖库
        run: |
          python -m pip install --upgrade pip  # 升级pip
          pip install yfinance  # 安装金价爬取依赖

      - name: 运行数据更新脚本
        run: |
          echo "开始运行数据更新脚本..."
          python data_updater.py
          echo "脚本运行完成，检查data.csv是否更新"

      - name: 提交并推送数据变更
        run: |
          # 配置Git用户信息
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # 检查是否有文件变更
          if git status --porcelain | grep -q "data.csv"; then
              git add data.csv
              git commit -m "自动更新金价数据: $(date +'%Y-%m-%d %H:%M:%S')"
              echo "提交变更：自动更新金价数据"
              git push origin main  # 显式指定推送到main分支
          else
              echo "无数据变更，无需提交"
          fi
